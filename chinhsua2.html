<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Nova Heart Letter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;overflow:hidden;background:#160016}

/* hint left */
#hintWrap{
  position:fixed;
  top:14px;
  left:16px;
  color:#fff;
  font-size:14px;
  opacity:.9;
  z-index:10
}
#hintText{transition:.4s}

/* hint right */
#hintTrigger{
  position:fixed;
  top:14px;
  right:16px;
  color:#fff;
  font-size:14px;
  cursor:pointer;
  opacity:.9;
  z-index:10
}

/* letter icon */
#letterIcon{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(.6);
  width:90px;
  opacity:0;
  pointer-events:none;
  transition:.5s;
  cursor:pointer;
  z-index:15
}
#letterIcon.show{
  opacity:1;
  pointer-events:auto;
  transform:translate(-50%,-50%) scale(1)
}
#letterIcon svg{
  fill:none;
  stroke:#ffffffcc;
  stroke-width:2;
  filter:
    drop-shadow(0 0 6px rgba(180,120,255,.7))
    drop-shadow(0 0 14px rgba(120,80,255,.5))
}

/* overlay */
#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:.6s;
  z-index:20
}
#overlay.show{opacity:1;pointer-events:auto}
#letterBox{
  width:min(90%,640px);
  padding:42px;
  border-radius:18px;
  background:rgba(255,255,255,.12);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.25);
  color:#fff
}
</style>
</head>

<body>

<div id="hintWrap">
  <div id="hintText">T√¨m ƒëi·ªÅu ƒë·∫∑c bi·ªát</div>
</div>

<div id="hintTrigger">G·ª£i √Ω n√® &gt;&gt;</div>

<div id="letterIcon">
  <svg viewBox="0 0 64 40">
    <rect x="2" y="6" width="60" height="28" rx="4"/>
    <path d="M4 8l28 18L60 8"/>
  </svg>
</div>

<div id="overlay">
  <div id="letterBox">‚ù§Ô∏è</div>
</div>

<script type="module">
import * as THREE from "https://cdn.skypack.dev/three@0.136.0";
import {OrbitControls} from "https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/OrbitControls";

/* ===== SCENE ===== */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x160016);

const camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,1,1000);
camera.position.set(0,4,21);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

const controls=new OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;
controls.enablePan=false;
controls.target.set(0,0,0);

/* ===== DATA ===== */
let gu={time:{value:0}};
let sizes=[],shift=[],base=[],heartLocal=[];
let morph=0,targetMorph=0;

let heartRotation=0;
let heartSpinSpeed=0;
let heartSpinTarget=0;

/* üîí h∆∞·ªõng tr·ª±c di·ªán c·ªë ƒë·ªãnh c·ªßa tr√°i tim (world-space) */
const heartFrontQuat=new THREE.Quaternion().setFromEuler(
  new THREE.Euler(
    THREE.MathUtils.degToRad(12),
    THREE.MathUtils.degToRad(8),
    0
  )
);
let heartBaseQuat=new THREE.Quaternion();

/* ===== NOVA ===== */
const COUNT=120000;
let pts=[];

const pushShift=()=>shift.push(
  Math.random()*Math.PI,
  Math.random()*Math.PI*2,
  (Math.random()*0.9+0.1)*Math.PI*0.1,
  Math.random()*0.9+0.1
);

for(let i=0;i<COUNT;i++){
  let v;
  if(i<COUNT/3){
    v=new THREE.Vector3().randomDirection().multiplyScalar(Math.random()*0.5+9.5);
  }else{
    let r=10,R=40;
    let rand=Math.pow(Math.random(),1.5);
    let radius=Math.sqrt(R*R*rand+(1-rand)*r*r);
    v=new THREE.Vector3().setFromCylindricalCoords(
      radius,Math.random()*Math.PI*2,(Math.random()-.5)*2
    );
  }
  pts.push(v.clone());
  base.push(v.clone());
  sizes.push(Math.random()*1.5+.5);
  pushShift();
}

/* ===== HEART SHAPE ===== */
for(let i=0;i<COUNT;i++){
  let t=Math.random()*Math.PI*2;
  let x=16*Math.pow(Math.sin(t),3);
  let y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t);
  let spread=Math.pow(Math.random(),0.6);
  let scale=THREE.MathUtils.lerp(0.15,0.45,spread);
  let z=(Math.random()-0.5)*10*spread;
  heartLocal.push(new THREE.Vector3(x,y,z).multiplyScalar(scale));
}

const g=new THREE.BufferGeometry().setFromPoints(pts);
g.setAttribute("sizes",new THREE.Float32BufferAttribute(sizes,1));
g.setAttribute("shift",new THREE.Float32BufferAttribute(shift,4));

const m=new THREE.PointsMaterial({
  size:0.125,
  transparent:true,
  depthTest:false,
  blending:THREE.AdditiveBlending,
  onBeforeCompile:s=>{
    s.uniforms.time=gu.time;
    s.vertexShader=`uniform float time; attribute float sizes; attribute vec4 shift; varying vec3 vColor; ${s.vertexShader}`
      .replace("gl_PointSize = size;","gl_PointSize = size * sizes;")
      .replace("#include <color_vertex>",`
        #include <color_vertex>
        float d=length(abs(position)/vec3(40.,10.,40));
        vColor=mix(vec3(227.,155.,0.),vec3(100.,50.,255.),clamp(d,0.,1.))/255.;
      `)
      .replace("#include <begin_vertex>",`
        #include <begin_vertex>
        float t=time;
        float a=mod(shift.x+shift.z*t,PI2);
        float b=mod(shift.y+shift.z*t,PI2);
        transformed+=vec3(cos(b)*sin(a),cos(a),sin(b)*sin(a))*shift.w;
      `);

    s.fragmentShader=`varying vec3 vColor; ${s.fragmentShader}`
      .replace(
        "vec4 diffuseColor = vec4( diffuse, opacity );",
        `
        float alpha = smoothstep(.5,.1,length(gl_PointCoord-.5));
        vec4 diffuseColor = vec4(vColor * 0.65, alpha);
        `
      );
  }
});

const points=new THREE.Points(g,m);
scene.add(points);

/* ===== UI ===== */
const letterIcon=document.getElementById("letterIcon");
const overlay=document.getElementById("overlay");
const hintText=document.getElementById("hintText");
const hintTrigger=document.getElementById("hintTrigger");

hintTrigger.onclick=()=>{
  hintText.textContent="Zoom v√†o t√¢m qu·∫£ c·∫ßu ƒëi n√†o";
  hintTrigger.style.display="none";
};

let camRestore=null;

letterIcon.onclick=()=>{
  overlay.classList.add("show");
  letterIcon.classList.remove("show");

  targetMorph=1;
  heartRotation=0;
  heartSpinSpeed=0;
  heartSpinTarget=0.025;

  camRestore=camera.position.clone();
  camera.position.copy(
    camera.position.clone().normalize().multiplyScalar(11)
  );
  camera.lookAt(0,0,0);

  /* üîí lu√¥n d√πng h∆∞·ªõng tim c·ªë ƒë·ªãnh */
  heartBaseQuat.copy(heartFrontQuat);
};

overlay.onclick=()=>{
  overlay.classList.remove("show");
  targetMorph=0;
  heartSpinTarget=0;
  if(camRestore) camera.position.copy(camRestore);
};

/* ===== ANIMATE ===== */
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  gu.time.value=clock.getElapsedTime()*Math.PI;

  points.rotation.y-=0.0018;

  morph+=(targetMorph-morph)*0.035;
  heartSpinSpeed+=(heartSpinTarget-heartSpinSpeed)*0.02;
  heartRotation+=heartSpinSpeed;

  const pos=g.attributes.position.array;
  const spinQuat=new THREE.Quaternion().setFromEuler(
    new THREE.Euler(0,heartRotation,0)
  );
  const finalQuat=heartBaseQuat.clone().multiply(spinQuat);

  for(let i=0;i<COUNT;i++){
    const b=base[i];
    const h=heartLocal[i].clone().applyQuaternion(finalQuat);
    pos[i*3]=THREE.MathUtils.lerp(b.x,h.x,morph);
    pos[i*3+1]=THREE.MathUtils.lerp(b.y,h.y,morph);
    pos[i*3+2]=THREE.MathUtils.lerp(b.z,h.z,morph);
  }
  g.attributes.position.needsUpdate=true;

  if(!overlay.classList.contains("show")){
    letterIcon.classList.toggle("show",camera.position.length()<11);
  }

  controls.update();
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
